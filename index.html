import React, { useEffect, useState, useRef } from "react";

// Mobile Vocab Trainer
// Single React component (default export) ready to drop into a React app.
// Uses localStorage for persistence so the web app and data remain private on your device.

const STORAGE_KEY = "vocab_trainer_v1";

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { vocabs: [] };
    return JSON.parse(raw);
  } catch (e) {
    console.error(e);
    return { vocabs: [] };
  }
}

function saveState(state) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// weighted random selection that reduces chance of recently-correct words
function pickWeighted(vocabs) {
  if (!vocabs || vocabs.length === 0) return null;
  // weight = 1 / (1 + correctCount)  -> more correct => smaller weight
  // also if lastSeen recently, slightly reduce weight
  const weights = vocabs.map((v) => {
    const base = 1 / (1 + (v.correctCount || 0));
    const penalty = v.recent ? 0.5 : 1; // penalize recently seen words
    return base * penalty;
  });
  const total = weights.reduce((a, b) => a + b, 0);
  if (total === 0) return vocabs[Math.floor(Math.random() * vocabs.length)];
  let r = Math.random() * total;
  for (let i = 0; i < vocabs.length; i++) {
    r -= weights[i];
    if (r <= 0) return vocabs[i];
  }
  return vocabs[vocabs.length - 1];
}

// Added full dark theme styling for UI, cards, buttons, inputs
export default function MobileVocabTrainer() {
  const [state, setState] = useState(() => loadState());
  const [showAdd, setShowAdd] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [engInput, setEngInput] = useState("");
  const [thaiInput, setThaiInput] = useState("");

  // quiz state
  const [current, setCurrent] = useState(null);
  const [answer, setAnswer] = useState("");
  const [feedback, setFeedback] = useState(null); // 'correct' | 'wrong' | null

  const answerRef = useRef(null);

  useEffect(() => {
    saveState(state);
  }, [state]);

  // mark all as not recent every time we pick a new one
  function pickNext() {
    const available = state.vocabs || [];
    if (available.length === 0) {
      setCurrent(null);
      setAnswer("");
      setFeedback(null);
      return;
    }
    // clear recent flags
    const cleared = available.map((v) => ({ ...v, recent: false }));
    const picked = pickWeighted(cleared);
    // mark chosen as recent
    const newVocabs = cleared.map((v) => (v.id === picked.id ? { ...v, recent: true } : v));
    setState((s) => ({ ...s, vocabs: newVocabs }));
    setCurrent(picked);
    setAnswer("");
    setFeedback(null);
    // focus answer input on mobile
    setTimeout(() => answerRef.current && answerRef.current.focus(), 150);
  }

  function addVocab() {
    const eng = engInput.trim();
    const th = thaiInput.trim();
    if (!eng || !th) return;
    const id = Date.now().toString();
    const newV = { id, eng, th, correctCount: 0, wrongCount: 0, recent: false };
    const newVocabs = [...(state.vocabs || []), newV];
    setState((s) => ({ ...s, vocabs: newVocabs }));
    setEngInput("");
    setThaiInput("");
  }

  function submitAnswer() {
    if (!current) return;
    const user = answer.trim();
    const correct = user.toLowerCase() === current.th.toLowerCase();
    setFeedback(correct ? "correct" : "wrong");
    // update counts and history placement
    setState((s) => {
      const vocabs = s.vocabs.map((v) => {
        if (v.id !== current.id) return v;
        const updated = { ...v };
        if (correct) {
          updated.correctCount = (updated.correctCount || 0) + 1;
          updated.wrongCount = updated.wrongCount || 0;
        } else {
          updated.wrongCount = (updated.wrongCount || 0) + 1;
        }
        return updated;
      });
      return { ...s, vocabs };
    });
  }

  function nextAfterAnswer() {
    // move between lists handled by counts; just pick next
    pickNext();
  }

  function enterHistory() {
    setShowHistory(true);
    setShowAdd(false);
  }

  function closeOverlays() {
    setShowAdd(false);
    setShowHistory(false);
  }

  function deleteCorrect(id) {
    const vocabs = (state.vocabs || []).filter((v) => v.id !== id);
    setState({ ...state, vocabs });
    // if deleting current, null it
    if (current && current.id === id) setCurrent(null);
  }

  // derived lists
  const correctList = (state.vocabs || []).filter((v) => (v.correctCount || 0) > (v.wrongCount || 0));
  const wrongList = (state.vocabs || []).filter((v) => (v.wrongCount || 0) >= (v.correctCount || 0) && (v.wrongCount || 0) > 0);

  // initial pick when there are vocabs and no current
  useEffect(() => {
    if (!current && (state.vocabs || []).length > 0 && !showAdd && !showHistory) {
      pickNext();
    }
    if ((state.vocabs || []).length === 0) {
      setCurrent(null);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [state.vocabs, showAdd, showHistory]);

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center p-4 sm:p-6">
      {/* Top bar */}
      <div className="w-full max-w-md">
        <div className="flex items-center justify-between py-2">
          <button
            onClick={enterHistory}
            className="text-sm px-3 py-2 rounded-lg bg-white shadow-sm"
            aria-label="open history"
          >
            ประวัติ
          </button>

          <div className="text-center font-semibold">คำศัพท์มือถือ</div>

          <div>
            <button
              onClick={() => setShowAdd((s) => !s)}
              className="text-sm px-3 py-2 rounded-lg bg-white shadow-sm"
              aria-label="add vocab"
            >
              {showAdd ? "ปิด" : "เพิ่มคำศัพท์"}
            </button>
          </div>
        </div>

        {/* Main card area */}
        <div className="mt-6 bg-white rounded-2xl shadow p-4 min-h-[60vh] flex flex-col justify-center items-center">
          {/* empty initial screen */}
          {(!state.vocabs || state.vocabs.length === 0) && !showAdd && !showHistory && (
            <div className="text-center text-slate-400">
              ไม่มีคำศัพท์ในระบบ
              <div className="mt-4 text-sm">กด "เพิ่มคำศัพท์" เพื่อเริ่มต้น</div>
            </div>
          )}

          {/* Show Add overlay content */}
          {showAdd && (
            <div className="w-full">
              <label className="block text-sm mb-1">คำศัพท์ (English)</label>
              <input
                className="w-full p-3 rounded-lg border"
                value={engInput}
                onChange={(e) => setEngInput(e.target.value)}
                placeholder="เช่น happy"
              />
              <label className="block text-sm mb-1 mt-3">คำแปล (ภาษาไทย)</label>
              <input
                className="w-full p-3 rounded-lg border"
                value={thaiInput}
                onChange={(e) => setThaiInput(e.target.value)}
                placeholder="เช่น มีความสุข"
              />
              <div className="flex gap-2 mt-4">
                <button
                  onClick={addVocab}
                  className="flex-1 py-3 rounded-lg bg-emerald-500 text-white font-medium"
                >
                  เพิ่ม
                </button>
                <button
                  onClick={closeOverlays}
                  className="flex-1 py-3 rounded-lg bg-slate-200"
                >
                  ปิด
                </button>
              </div>
            </div>
          )}

          {/* Quiz area */}
          {!showAdd && !showHistory && current && (
            <div className="w-full">
              <div className="text-center text-2xl font-semibold p-4">{current.eng}</div>

              <label className="block text-sm mb-1">พิมพ์คำแปล</label>
              <input
                ref={answerRef}
                className={`w-full p-3 rounded-lg border ${
                  feedback === "correct" ? "border-emerald-500" : feedback === "wrong" ? "border-rose-500" : "border-slate-200"
                }`}
                value={answer}
                onChange={(e) => setAnswer(e.target.value)}
                placeholder="พิมพ์คำแปลเป็นภาษาไทย"
                disabled={feedback !== null}
              />

              {feedback === "wrong" && (
                <div className="mt-2 text-sm text-rose-600">คำตอบที่ถูกต้อง: {current.th}</div>
              )}

              <div className="flex gap-2 mt-4">
                <button
                  onClick={submitAnswer}
                  className="flex-1 py-3 rounded-lg bg-indigo-600 text-white"
                  disabled={feedback !== null}
                >
                  ส่งคำตอบ
                </button>
                {feedback && (
                  <button onClick={nextAfterAnswer} className="py-3 px-4 rounded-lg bg-slate-100">
                    NEXT
                  </button>
                )}
              </div>

              <div className="mt-6 text-xs text-slate-400">คำศัพท์จะแสดงแบบสุ่ม — คำที่ตอบถูกบ่อยจะมีโอกาสน้อยลง</div>
            </div>
          )}

          {/* If vocab exists but none picked (e.g., after deletion) */}
          {!showAdd && !showHistory && state.vocabs && state.vocabs.length > 0 && !current && (
            <div className="text-center text-slate-500">พร้อม — กำลังเลือกคำศัพท์...</div>
          )}
        </div>

        {/* History panel (full screen overlay inside card) */}
        {showHistory && (
          <div className="mt-4 bg-white rounded-2xl shadow p-4">
            <div className="flex justify-between items-center mb-3">
              <div className="font-medium">ประวัติการตอบ</div>
              <button onClick={closeOverlays} className="text-sm p-2 bg-slate-100 rounded">ปิด</button>
            </div>

            <div className="flex gap-3">
              <div className="flex-1">
                <div className="text-sm font-medium mb-2">ตอบถูก ({correctList.length})</div>
                <div className="space-y-2 max-h-[40vh] overflow-auto pr-2">
                  {correctList.map((v) => (
                    <div key={v.id} className="flex items-center justify-between border rounded p-2">
                      <div>
                        <div className="text-sm font-medium">{v.eng}</div>
                        <div className="text-xs text-slate-500">{v.th}</div>
                      </div>
                      <div className="flex flex-col items-end gap-2">
                        <button onClick={() => deleteCorrect(v.id)} className="text-xs text-rose-600">ลบ</button>
                      </div>
                    </div>
                  ))}
                  {correctList.length === 0 && <div className="text-xs text-slate-400">ยังไม่มีคำที่ตอบถูก</div>}
                </div>
              </div>

              <div className="flex-1">
                <div className="text-sm font-medium mb-2">ตอบผิด ({wrongList.length})</div>
                <div className="space-y-2 max-h-[40vh] overflow-auto pr-2">
                  {wrongList.map((v) => (
                    <div key={v.id} className="border rounded p-2">
                      <div className="text-sm font-medium">{v.eng}</div>
                      <div className="text-xs text-slate-500">ถูกต้อง: {v.th}</div>
                    </div>
                  ))}
                  {wrongList.length === 0 && <div className="text-xs text-slate-400">ยังไม่มีคำที่ตอบผิด</div>}
                </div>
              </div>
            </div>

            <div className="mt-4 text-xs text-slate-400">หมายเหตุ: แค่แสดง — ฝั่งผิดไม่สามารถแก้ไขได้โดยตรง แต่เมื่อคุณตอบคำศัพท์ใหม่และผลต่างออกไป ระบบจะย้ายคำนั้นอัตโนมัติ</div>
          </div>
        )}
      </div>

      <div className="text-center text-xs text-slate-400 mt-4">ข้อมูลเก็บไว้ในอุปกรณ์ของคุณเท่านั้น (localStorage) — แชร์ไฟล์นี้หรือส่งลิงก์ด้วยตัวคุณเองเท่านั้น</div>
    </div>
  );
}
